<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!--
    RETAILPRO - AI Sales Assistant
    Sistema Inteligente de Assistência a Vendas para Varejo
    Versão: 1.0.0
    
    ARQUITETURA:
    - Frontend: HTML5, Tailwind CSS, Lucide Icons
    - Comunicação: REST API (fetch)
    - Estado: Client-side com sincronização em tempo real
    
    PRINCIPAIS FUNCIONALIDADES:
    1. Gestão de Catálogo de Produtos
    2. Coach de Vendas com Timeline Programável
    3. Carrinho de Vendas com Cross-Sell
    4. Sistema de Pontuação por Performance
    5. Telemetria de Atendimento
    
    PADRÕES ADOTADOS:
    - Design Responsivo (Mobile First)
    - Feedback Visual Imediato
    - Estado Persistente por Sessão
    - Comunicação Assíncrona
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailPro | Intelligent Sales Coach</title>

    <!-- DEPENDÊNCIAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- ESTILOS PERSONALIZADOS -->
    <style>
        /* 
        SISTEMA DE DESIGN:
        - Cores Primárias: Blue (#2563eb) para ações, Amber (#f59e0b) para alertas
        - Tipografia: Plus Jakarta Sans (UI), JetBrains Mono (dados)
        - Espaçamento: Escala 4px (0.25rem)
        - Breakpoints: Mobile (<640px), Tablet (640-1024px), Desktop (>1024px)
        */

        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap');

        :root {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --accent-blue: #2563eb;
            --accent-amber: #f59e0b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: #1e293b;
        }

        /* 
        ANIMAÇÕES E TRANSITIONS:
        - Carrinho Lateral: Slide-in da direita (300ms)
        - Toast Notifications: Entrada/Saída com keyframes
        - Coach Pulse: Indicador de atividade (2s loop)
        - Modal Overlay: Blur backdrop para foco
        */

        #carrinhoLateral {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }

        #carrinhoLateral.open {
            transform: translateX(0);
        }

        .card-shadow {
            background: var(--bg-card);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        /* 
        COMPONENTES REUTILIZÁVEIS:
        - custom-scroll: Scrollbar personalizada
        - active-item: Estado ativo para itens de lista
        - sticky-coach: Posicionamento fixo durante scroll
        */

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .active-item {
            background: #eff6ff !important;
            border-right: 4px solid var(--accent-blue);
        }

        .coach-pulse {
            animation: coach-pulse-ring 2s infinite;
        }

        .toast-success {
            animation: toast-in 0.5s ease-out forwards, toast-out 0.5s ease-in forwards 2.5s;
        }

        /* KEYFRAMES PARA ANIMAÇÕES */
        @keyframes toast-in {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toast-out {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(100px);
                opacity: 0;
            }
        }

        @keyframes coach-pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        /* 
        COMPONENTES DE OVERLAY:
        - Modal com backdrop blur
        - Z-index hierarchy: Modal (50), Toast (100)
        */

        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        /* 
        ESTRUTURA RESPONSIVA:
        - Layout em coluna para mobile
        - Layout em linha para desktop
        - Coach permanece visível durante scroll
        */

        .sticky-coach {
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .aside-scrollable {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .main-container {
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
            }
        }

        /* 
        AJUSTES PARA MOBILE:
        - Redução de font-size para melhor legibilidade
        - Ajuste de padding para touch targets
        */

        @media (max-width: 640px) {
            #panelCoach p {
                font-size: 1rem;
            }

            #coachTimer {
                font-size: 1.25rem;
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">
    <!-- 
    CONTAINER DE NOTIFICAÇÕES:
    - Posicionamento fixo no bottom-center
    - Pointer-events: none para não interferir com clicks
    - Z-index máximo para sobreposição
    -->
    <div id="toastContainer" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] pointer-events-none"></div>

    <!-- 
    HEADER - BARRA SUPERIOR:
    Contém:
    1. Logo e identificação do sistema
    2. Barra de performance do vendedor
    3. Controles de estoque e carrinho
    4. Botão de desistência (condicional)
    -->
    <header class="h-20 border-b border-slate-200 bg-white px-8 flex items-center justify-between shrink-0 z-10">
        <div class="flex items-center gap-8">
            <!-- LOGO E IDENTIFICAÇÃO -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i data-lucide="zap" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="font-extrabold tracking-tight text-slate-900 leading-none text-lg">RETAIL<span
                            class="text-blue-600">PRO</span></h1>
                    <span class="text-[10px] text-slate-400 font-mono tracking-widest uppercase">AI Sales
                        Assistant</span>
                </div>
            </div>

            <!-- BARRA DE PERFORMANCE -->
            <div class="flex flex-col">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Performance</span>
                    <span id="pontosVenda" class="text-xs font-black text-blue-600">0 pts</span>
                </div>
                <div class="w-40 h-2 bg-slate-100 rounded-full overflow-hidden border">
                    <div id="barraPerformance" class="h-full w-0 bg-blue-600 transition-all"></div>
                </div>
            </div>
        </div>

        <!-- CONTROLES DO HEADER -->
        <div class="flex gap-2 items-center">
            <!-- CONTROLE DE REABASTECIMENTO -->
            <div class="flex items-center bg-slate-50 rounded-xl border px-2 mr-2">
                <input type="number" id="qtdRestock" value="10"
                    class="w-10 bg-transparent text-center font-bold text-xs outline-none">
                <button onclick="reabastecerItem()"
                    class="text-[10px] font-bold uppercase p-2 text-slate-500 hover:text-blue-600">Entrada</button>
            </div>

            <!-- BOTÃO DE DESISTÊNCIA (CONDICIONAL) -->
            <button id="btnCancelar" onclick="abrirModalDesistencia()"
                class="hidden px-4 py-2.5 bg-white text-red-500 border border-red-100 rounded-xl font-bold text-[11px] uppercase hover:bg-red-50 transition-all flex items-center gap-2">
                <i data-lucide="user-x" class="w-4 h-4"></i> Desistência
            </button>

            <!-- BOTÃO DO CARRINHO COM BADGE -->
            <button onclick="toggleCarrinho()"
                class="relative px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-[11px] uppercase shadow-lg shadow-blue-200 flex items-center gap-2 transition-all hover:bg-blue-700">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                Meu Carrinho
                <span id="badgeCarrinho"
                    class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center border-2 border-white hidden animate-bounce">0</span>
            </button>
        </div>
    </header>

    <!-- 
    LAYOUT PRINCIPAL - TRÊS COLUNAS:
    1. Coluna Esquerda: Lista de produtos (catálogo)
    2. Coluna Central: Detalhes do produto + Coach
    3. Coluna Direita: Cross-sell + Editor de roteiro
    -->
    <div class="flex flex-1 overflow-hidden main-container">
        <!-- 
        COLUNA ESQUERDA - CATÁLOGO:
        - Lista de produtos agrupados por modelo
        - Busca em tempo real
        - Indicador de estoque total
        -->
        <aside class="w-full lg:w-72 border-r border-slate-200 flex flex-col bg-white shrink-0 h-48 lg:h-auto">
            <div class="p-4 border-b">
                <div class="relative flex items-center gap-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="filtroLista" oninput="filtrarLista()" placeholder="Buscar..."
                            class="w-full bg-slate-50 border rounded-xl py-2 pl-9 pr-4 text-xs outline-none focus:ring-2 ring-blue-100 transition-all">
                    </div>
                    <button onclick="limparFiltro()" id="btnLimparFiltro"
                        class="hidden p-2 bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600 rounded-xl transition-all"
                        title="Limpar busca">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div id="listaProdutos" class="flex-1 overflow-y-auto custom-scroll px-2 py-4"></div>
        </aside>

        <!-- 
        COLUNA CENTRAL - ÁREA DE VENDAS:
        Contém:
        1. Dica de argumentação (condicional)
        2. Painel do Coach com timer
        3. Detalhes completos do produto
        4. Grade de variantes (tamanhos)
        5. Ficha técnica
        -->
        <main class="flex-1 overflow-y-auto custom-scroll bg-white relative">
            <!-- DICA DE ARGUMENTAÇÃO (BANNER SUPERIOR) -->
            <div id="containerDiferenciais"
                class="hidden w-full bg-emerald-600 border-b border-emerald-500 shadow-sm transition-all duration-500">
                <div class="w-full px-10 py-3 flex items-center justify-start gap-4">
                    <div
                        class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center shrink-0 border border-white/20">
                        <i data-lucide="sparkles" class="w-4 h-4 text-emerald-100"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p
                            class="text-[9px] font-black uppercase tracking-[0.15em] text-emerald-200/80 leading-none mb-1">
                            Dica de Argumentação
                        </p>
                        <p id="textoDiferenciais"
                            class="text-white font-semibold text-sm leading-tight tracking-tight opacity-95">
                        </p>
                    </div>
                </div>
            </div>

            <!-- 
            PAINEL DO COACH DE VENDAS:
            - Timer de atendimento
            - Mensagens programáveis por timeline
            - Feedback visual por tipo (info/alerta)
            - Posicionamento sticky durante scroll
            -->
            <div id="panelCoach"
                class="hidden sticky-coach bg-blue-600 p-8 text-white shadow-xl transition-all duration-500 coach-pulse border-b border-blue-400/30">
                <div class="flex justify-between items-center w-full">
                    <div class="flex-1">
                        <span class="text-[10px] font-black uppercase tracking-widest opacity-70 block mb-1">Coach de
                            Vendas Ativo</span>
                        <p id="coachMsg" class="text-2xl font-extrabold leading-tight tracking-tighter">Iniciando
                            abordagem...</p>
                    </div>
                    <div class="text-right pl-6">
                        <span id="coachTimer"
                            class="font-mono font-bold text-3xl bg-black/20 px-8 py-3 rounded-2xl inline-block">00:00</span>
                    </div>
                </div>
            </div>

            <!-- 
            DETALHES DO PRODUTO SELECIONADO:
            - Informações principais
            - Controle de adição ao carrinho
            - Grade de variantes (tamanhos)
            - Especificações técnicas
            -->
            <div id="detalhesProduto" class="hidden flex flex-col w-full">
                <!-- CABEÇALHO DO PRODUTO -->
                <div class="bg-white p-10 border-b border-slate-100 flex justify-between items-center w-full">
                    <div>
                        <span id="resCategoria"
                            class="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg"></span>
                        <h2 id="resNome" class="text-4xl font-black text-slate-900 mt-3 tracking-tighter leading-none">
                        </h2>
                        <div class="flex items-center gap-6 mt-8">
                            <span class="flex items-center gap-2 text-xs font-bold text-slate-400">
                                <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i> <span id="resLocal"></span>
                            </span>
                            <span class="flex items-center gap-2 text-xs font-bold text-slate-400">
                                <i data-lucide="package" class="w-4 h-4 text-blue-500"></i> Estoque: <span id="resQtd"
                                    class="text-slate-900 font-black"></span>
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="resPreco" class="text-6xl font-black text-slate-900 tracking-tighter"></p>
                    </div>
                </div>

                <!-- BOTÃO PRIMÁRIO DE AÇÃO -->
                <button onclick="adicionarAoCarrinho()"
                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-6 flex items-center justify-center gap-3 font-black uppercase text-xs tracking-[0.2em] transition-all border-y border-emerald-400/30 shadow-inner group">
                    <i data-lucide="shopping-cart" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    Adicionar este item ao carrinho
                </button>

                <!-- CONTEÚDO SECUNDÁRIO (GRID) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 w-full">
                    <!-- GRADE DE TAMANHOS -->
                    <div class="p-10 bg-white border-b lg:border-b-0 lg:border-r border-slate-100">
                        <h3 class="text-[11px] font-black uppercase tracking-[0.2em] text-slate-400 mb-8">Grade de
                            Tamanhos</h3>
                        <div id="gradeVariantes" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        </div>
                    </div>

                    <!-- FICHA TÉCNICA -->
                    <div class="p-10 bg-slate-50/50">
                        <h3 class="text-[11px] font-black uppercase tracking-[0.2em] text-slate-400 mb-8">Ficha Técnica
                        </h3>
                        <div id="listaEspecificacoes"
                            class="grid grid-cols-1 sm:grid-cols-2 gap-px bg-slate-200 border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 
        COLUNA DIREITA - RECURSOS DE VENDA:
        Contém:
        1. Sugestões de Cross-Sell
        2. Editor de roteiro do Coach
        3. Controles de programação da timeline
        -->
        <aside class="w-80 border-l border-slate-200 flex flex-col bg-white shrink-0 h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto custom-scroll">
                <!-- SEÇÃO DE CROSS-SELL -->
                <div id="secaoSugestoes" class="hidden p-5 border-b">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Cross-Sell</h4>
                    <div id="containerSugestoes" class="space-y-2"></div>
                </div>

                <!-- 
                EDITOR DE ROTEIRO DO COACH:
                - Timeline programável por segundos
                - Tipos: INFO (azul) e ALERTA (âmbar)
                - Interface de arrastar/soltar (implícita)
                -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="p-5 flex flex-col flex-1 overflow-hidden">
                        <h3
                            class="text-[11px] font-black uppercase tracking-widest text-slate-900 mb-4 flex items-center gap-2">
                            <i data-lucide="list-ordered" class="w-4 h-4 text-blue-600"></i> Editor de Roteiro
                        </h3>
                        <div id="listaEditor" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
                    </div>

                    <!-- FORMULÁRIO DE ADIÇÃO/EDIÇÃO -->
                    <div class="p-5 bg-slate-50 border-t">
                        <div class="grid grid-cols-12 gap-2">
                            <input type="number" id="editSeg" placeholder="Seg"
                                class="col-span-4 border rounded-lg p-2 text-xs font-bold outline-none focus:border-blue-500">
                            <select id="editTipo"
                                class="col-span-8 border rounded-lg p-2 text-[10px] font-bold outline-none">
                                <option value="info">INFO (Azul)</option>
                                <option value="alert">ALERTA (Âmbar)</option>
                            </select>
                            <input type="text" id="editMsg" placeholder="Mensagem do Coach..."
                                class="col-span-12 border rounded-lg p-2 text-xs outline-none focus:border-blue-500">
                            <button id="btnSalvar" onclick="adicionarOuAtualizar()"
                                class="col-span-12 mt-1 bg-blue-600 text-white py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-700 transition-all">
                                Salvar Roteiro
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 
    MODAL DE DESISTÊNCIA:
    - Overlay com blur backdrop
    - Lista de motivos pré-definidos
    - Confirmação com telemetria
    -->
    <div id="modalDesistencia" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="text-center mb-6 shrink-0">
                <div
                    class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="frown" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-extrabold text-slate-900">Motivo da Desistência</h3>
                <p class="text-xs text-slate-400 mt-1">Por que o cliente não finalizou a compra?</p>
            </div>

            <!-- LISTA DE MOTIVOS PRÉ-DEFINIDOS -->
            <div class="space-y-2 overflow-y-auto custom-scroll pr-2" id="listaMotivos">
                <button onclick="confirmarDesistencia('Preço Elevado')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Preço Elevado
                    <i data-lucide="banknote" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>

                <button onclick="confirmarDesistencia('Falta de Tamanho/Cor')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Sem o Tamanho ou Cor
                    <i data-lucide="layers" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>

                <button onclick="confirmarDesistencia('Não gostou do material')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Qualidade/Material
                    <i data-lucide="thumbs-down" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>

                <button onclick="confirmarDesistencia('Viu mais barato no concorrente')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Preço Melhor no Concorrente
                    <i data-lucide="search" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>

                <button onclick="confirmarDesistencia('Tempo de espera/Fila')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Demora no Atendimento
                    <i data-lucide="clock" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>

                <button onclick="confirmarDesistencia('Apenas pesquisando')"
                    class="w-full p-4 text-left rounded-2xl border border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-sm flex justify-between items-center group">
                    Apenas Pesquisando
                    <i data-lucide="eye" class="w-4 h-4 text-slate-300 group-hover:text-blue-500"></i>
                </button>
            </div>

            <button onclick="fecharModalDesistencia()"
                class="w-full py-4 text-slate-400 font-bold text-[10px] uppercase mt-4 shrink-0">Voltar para a
                Venda</button>
        </div>
    </div>

    <!-- 
    CARRINHO LATERAL:
    - Slide-in da direita
    - Lista de itens com controles de quantidade
    - Totalizador em tempo real
    - Botão de finalização com sincronização
    -->
    <div id="carrinhoLateral"
        class="fixed right-0 top-0 h-full w-80 bg-white shadow-2xl z-50 flex flex-col border-l border-slate-200">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
            <h3 class="font-black uppercase text-xs tracking-widest">Carrinho de Vendas</h3>
            <button onclick="toggleCarrinho()" class="p-1 hover:bg-blue-500 rounded"><i data-lucide="x"
                    class="w-5 h-5"></i></button>
        </div>

        <!-- LISTA DE ITENS DO CARRINHO -->
        <div id="listaItensCarrinho" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll">
        </div>

        <!-- RODAPÉ DO CARRINHO -->
        <div class="p-6 border-t bg-slate-50">
            <div class="flex justify-between items-end mb-4">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Total do Pedido</span>
                <span id="totalCarrinho" class="text-2xl font-black text-slate-900">R$ 0,00</span>
            </div>
            <button onclick="finalizarPedido()"
                class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold uppercase text-[11px] tracking-widest transition-all shadow-lg shadow-emerald-100">
                Finalizar e Sincronizar
            </button>
        </div>
    </div>

    <div id="modalQuickView"
        class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[999] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">

            <div class="p-5 border-b flex justify-between items-center bg-white">
                <div>
                    <span id="qvCategoria"
                        class="text-[8px] font-black text-blue-600 uppercase tracking-widest">CATEGORIA</span>
                    <h3 id="qvNome" class="text-lg font-bold text-slate-800 leading-tight">Nome</h3>
                </div>
                <button onclick="fecharQuickView()" class="p-2 hover:bg-slate-100 rounded-full transition-all">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="space-y-6">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Preço Sugerido</p>
                            <p id="qvPreco" class="text-2xl font-black text-slate-900">R$ 0,00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Localização</p>
                            <p id="qvLocal" class="text-xs font-bold text-slate-600">-- / --</p>
                        </div>
                    </div>

                    <div id="qvGradeTamanhos"></div>

                    <div id="qvContainerDif" class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p id="qvTextoDif" class="text-[11px] text-emerald-800 font-medium leading-relaxed"></p>
                    </div>

                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Especificações</p>
                        <div id="qvListaSpecs" class="grid grid-cols-1 gap-x-4"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t text-center">
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Consulta Técnica RetailPro</p>
            </div>
        </div>
    </div>

    <!-- 
    SCRIPT PRINCIPAL - LÓGICA DA APLICAÇÃO
    VARIÁVEIS GLOBAIS:
    - skuAtual: SKU do produto selecionado
    - pontuacao: Pontos de performance do vendedor
    - coachInterval: Referência do timer do coach
    - tempoSegundos: Duração do atendimento atual
    - timelineVenda: Array com a programação do coach
    - salesTipGlobal: Dica de venda do produto atual
    - carrinhoAtual: Array com itens do carrinho
    - vendedorId: Identificador do vendedor (hardcoded para demo)
    - sessionId: Identificador da sessão (null até ser gerado)
    -->
    <script>
        // Inicialização dos ícones Lucide
        lucide.createIcons();

        // Variáveis de estado global
        let skuAtual = "";
        let pontuacao = 0;
        let coachInterval = null;
        let tempoSegundos = 0;
        let timelineVenda = [];
        let salesTipGlobal = "";
        let carrinhoAtual = [];
        let vendedorId = 1; // Simulado para este exemplo
        let sessionId = null;

        // 
        // FUNÇÕES PRINCIPAIS DA APLICAÇÃO
        // 

        /**
         * INICIALIZAÇÃO DA APLICAÇÃO
         * Executada quando a página é carregada
         */
        window.onload = () => {
            carregarCatalogo();
            limparPainelCentral();
        };

        /**
         * REABASTECIMENTO DE ESTOQUE
         * Atualiza a quantidade disponível de um produto
         * @async
         */
        async function reabastecerItem() {
            const inputQtd = document.getElementById('qtdRestock');
            const q = inputQtd.value;

            if (!skuAtual || q <= 0) return alert("Selecione um item e digite a quantidade!");

            try {
                const res = await fetch(`/api/products/restock/${skuAtual}?quantity=${q}`, { method: 'PATCH' });

                if (res.ok) {
                    const data = await res.json();

                    // 1. Atualiza o número grande de estoque no painel central
                    document.getElementById('resQtd').innerText = data.novoEstoque;

                    // 2. Atualiza o texto de estoque dentro do botão da variante (ex: "Estoque: 15")
                    // Isso garante que a grade de tamanhos reflita o novo valor imediatamente
                    const btnVariante = document.querySelector(`#btn-sku-${skuAtual} span:last-child`);
                    if (btnVariante) {
                        btnVariante.innerText = `Estoque: ${data.novoEstoque}`;
                    }

                    // 3. Atualiza o estado do botão de vender no Header (caso estivesse desabilitado)
                    atualizarBotaoHeader(data.novoEstoque);

                    // FEEDBACK: Não precisamos mais recarregar o catálogo lateral (carregarCatalogo)
                    // pois agora ele contém apenas informações estáticas.

                    mostrarAvisoVisual("Estoque Atualizado!");
                    inputQtd.value = ""; // Limpa o campo de entrada
                }
            } catch (err) {
                console.error("Erro ao reabastecer:", err);
                alert("Erro de comunicação com o servidor.");
            }
        }

        /**
         * CARREGAMENTO DO CATÁLOGO
         * Busca produtos da API e renderiza na lista lateral
         * @async
         */
        async function carregarCatalogo() {
            try {
                const res = await fetch(`/api/products?nocache=${Date.now()}`);
                const produtos = await res.json();

                // Agrupamos apenas para ter a lista de nomes únicos, sem precisar somar quantidades
                const resumoModelos = produtos.reduce((acc, p) => {
                    if (!acc[p.name]) {
                        acc[p.name] = { name: p.name, category: p.category };
                    }
                    return acc;
                }, {});

                const modelos = Object.values(resumoModelos);
                const listaProdutos = document.getElementById('listaProdutos');

                // Renderização: Agora com informação estática
                listaProdutos.innerHTML = modelos.map(p => {
                    const safeId = `card-${p.name.replace(/\s+/g, '-')}`;
                    return `
                <button id="${safeId}" onclick="abrirModelo('${p.name}', this)" 
                        class="card-modelo w-full text-left p-4 rounded-xl hover:bg-slate-50 flex flex-col mb-1 transition-all border border-transparent">
                    <span class="text-[8px] text-blue-600 font-black uppercase mb-1 tracking-widest">${p.category}</span>
                    <span class="text-sm font-bold text-slate-700">${p.name}</span>
                    
                    <div class="flex items-center gap-1 mt-2 text-slate-400">
                        <i data-lucide="info" class="w-3 h-3"></i>
                        <span class="text-[9px] font-medium italic">Clique para ver grades e estoque</span>
                    </div>
                </button>`;
                }).join('');

                lucide.createIcons();

            } catch (err) {
                console.error("Erro ao carregar catálogo:", err);
            }
        }

        /**
         * ABERTURA DE UM MODELO DE PRODUTO
         * Carrega detalhes e variantes do produto selecionado
         * @param {string} nome - Nome do modelo
         * @param {HTMLElement} el - Elemento HTML clicado (opcional)
         * @async
         */
        async function abrirModelo(nome, el) {
            // Gerencia estado visual ativo
            document.querySelectorAll('.card-modelo').forEach(c => c.classList.remove('active-item'));

            if (el) {
                el.classList.add('active-item');
            } else {
                const safeId = `card-${nome.replace(/\s+/g, '-')}`;
                const card = document.getElementById(safeId);
                if (card) card.classList.add('active-item');
            }

            // Busca dados e renderiza painel central
            document.getElementById('detalhesProduto').classList.remove('hidden');
            const res = await fetch(`/api/products/model/${nome}`);
            const data = await res.json();

            document.getElementById('resNome').innerText = data.name;
            document.getElementById('resCategoria').innerText = data.category;
            document.getElementById('resPreco').innerText = `R$ ${data.basePrice.toFixed(2)}`;
            document.getElementById('resLocal').innerText = `${data.aisle} / ${data.shelf}`;

            // Renderiza grade de tamanhos
            document.getElementById('gradeVariantes').innerHTML = data.availableSizes.map(v => `
        <button onclick="selecionarVariante('${v.sku}')" id="btn-sku-${v.sku}" 
                class="sku-btn p-4 rounded-2xl border bg-white hover:border-blue-500 transition-all text-center flex flex-col items-center">
            <span class="text-lg font-black text-slate-800">${v.tamanho}</span>
            <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">Estoque: ${v.quantity}</span>
        </button>`).join('');

            selecionarVariante(data.availableSizes[0].sku);
        }

        /**
         * SELEÇÃO DE VARIANTE (SKU)
         * Carrega detalhes específicos de uma variante (tamanho/cor)
         * @param {string} sku - SKU da variante
         * @param {boolean} isCrossSell - Indica se é produto de cross-sell
         * @async
         */
        async function selecionarVariante(sku, isCrossSell = false) {
            const res = await fetch(`/api/products/sku/${sku}`);
            if (!res.ok) return;
            const data = await res.json();
            skuAtual = sku;
            timelineVenda = data.timeline || [];
            salesTipGlobal = data.details.salesTip || "Destaque as qualidades deste item.";

            // UI: Destaque do botão de SKU ativo
            document.querySelectorAll('.sku-btn').forEach(b => b.classList.remove('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-100'));
            const activeBtn = document.getElementById(`btn-sku-${sku}`);
            if (activeBtn) activeBtn.classList.add('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-100');

            // Atualiza informações básicas
            document.getElementById('resQtd').innerText = data.details.quantity;

            // Gerencia dica de argumentação (banner verde)
            const containerDif = document.getElementById('containerDiferenciais');
            const textoDif = document.getElementById('textoDiferenciais');
            const detalhesProd = document.getElementById('detalhesProduto');

            if (data.details.benefits) {
                containerDif.classList.remove('hidden');
                textoDif.innerText = data.details.benefits;
                detalhesProd.classList.add('mt-6');
            } else {
                containerDif.classList.add('hidden');
                detalhesProd.classList.remove('mt-6');
            }

            // Renderiza especificações técnicas
            const listaSpecs = document.getElementById('listaEspecificacoes');
            listaSpecs.innerHTML = Object.entries(data.details.specifications).map(([key, value]) => `
    <div class="p-6 bg-white flex flex-col justify-center">
        <p class="text-[9px] font-black text-blue-600 uppercase mb-1 tracking-widest">${key}</p>
        <p class="text-sm font-bold text-slate-800">${value}</p>
    </div>`).join('');

            // Lógica de pontuação para cross-sell
            if (isCrossSell) atualizarPontuacao(150);

            // Inicializa componentes dependentes
            renderizarEditor();
            iniciarMotorCoach();

            // Mostra controles condicionais
            document.getElementById('btnCancelar').classList.remove('hidden');
            document.getElementById('secaoSugestoes').classList.remove('hidden');

            // Renderiza sugestões de cross-sell
            document.getElementById('containerSugestoes').innerHTML = data.suggestions.map(s => `
    <div class="flex flex-col p-4 bg-white rounded-xl border-2 border-slate-50 hover:border-blue-200 shadow-sm transition-all group mb-3">
        <div class="flex items-center justify-between mb-2">
            <div onclick="abrirQuickView('${s.sku}')" class="cursor-pointer flex-1 pr-2">
                <p class="text-[11px] font-black text-slate-900 uppercase tracking-tight group-hover:text-blue-600 transition-colors">
                    ${s.name}
                </p>
                <p class="text-sm text-blue-600 font-extrabold">R$ ${s.price.toFixed(2).replace('.', ',')}</p>
                <span class="text-[8px] text-slate-400 font-bold uppercase flex items-center gap-1 mt-1">
                    <i data-lucide="eye" class="w-3 h-3"></i> Clique para detalhes técnicos
                </span>
            </div>
            
            <button onclick="adicionarCrossSellAoCarrinho('${s.sku}', '${s.name}', ${s.price})" 
                    class="p-2.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-sm">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
            </button>
        </div>
    </div>`).join('');

            lucide.createIcons();
            atualizarBotaoHeader(data.details.quantity);
        }

        /**
         * INICIALIZAÇÃO DO MOTOR DO COACH
         * Inicia timer e controla exibição das mensagens programadas
         */
        function iniciarMotorCoach() {
            tempoSegundos = 0;
            if (coachInterval) clearInterval(coachInterval);
            const panel = document.getElementById('panelCoach');
            const msgEl = document.getElementById('coachMsg');
            panel.classList.remove('hidden');
            msgEl.innerText = salesTipGlobal;

            // Intervalo principal do coach (1 segundo)
            coachInterval = setInterval(() => {
                tempoSegundos++;
                document.getElementById('coachTimer').innerText = `${Math.floor(tempoSegundos / 60).toString().padStart(2, '0')}:${(tempoSegundos % 60).toString().padStart(2, '0')}`;

                // Verifica se há mensagem programada para este segundo
                const passo = timelineVenda.find(x => (x.second || x.Second) === tempoSegundos);
                if (passo) {
                    msgEl.innerText = passo.message || passo.Message;

                    // Aplica estilo baseado no tipo (info/alerta)
                    const baseClasses = "sticky-coach p-6 text-white shadow-2xl transition-all duration-500 coach-pulse border-b";
                    panel.className = (passo.type || passo.Type) === 'alert'
                        ? `${baseClasses} bg-amber-500 border-amber-400`
                        : `${baseClasses} bg-blue-600 border-blue-400`;
                }
            }, 1000);
        }

        /**
         * CONTROLES DO MODAL DE DESISTÊNCIA
         */
        function abrirModalDesistencia() { document.getElementById('modalDesistencia').classList.remove('hidden'); }
        function fecharModalDesistencia() { document.getElementById('modalDesistencia').classList.add('hidden'); }

        /**
         * RENDERIZAÇÃO DO EDITOR DE ROTEIRO
         * Atualiza a lista de passos programados do coach
         */
        function renderizarEditor() {
            const lista = document.getElementById('listaEditor');
            lista.innerHTML = timelineVenda.map((t, i) => `
                <div class="flex items-center gap-2 bg-white p-3 rounded-xl border group hover:border-blue-300 transition-all">
                    <span class="font-mono font-bold text-blue-600 text-[10px] bg-blue-50 px-2 py-1 rounded">${t.second || t.Second}s</span>
                    <span class="flex-1 text-[11px] text-slate-600 font-medium truncate">${t.message || t.Message}</span>
                    <button onclick="removerPasso(${i})" class="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>`).join('');
            lucide.createIcons();
        }

        /**
         * ADIÇÃO OU ATUALIZAÇÃO DE PASSO NO ROTEIRO
         * Adiciona novo passo à timeline e sincroniza com a API
         * @async
         */
        async function adicionarOuAtualizar() {
            const s = document.getElementById('editSeg').value;
            const m = document.getElementById('editMsg').value;
            const t = document.getElementById('editTipo').value;

            if (!s || !m) return;

            timelineVenda.push({ second: parseInt(s), message: m, type: t });
            timelineVenda.sort((a, b) => (a.second || a.Second) - (b.second || b.Second));

            await salvarNoBanco();
            document.getElementById('editSeg').value = "";
            document.getElementById('editMsg').value = "";
        }

        /**
         * REMOÇÃO DE PASSO DO ROTEIRO
         * Remove passo da timeline e sincroniza com a API
         * @param {number} i - Índice do passo a ser removido
         * @async
         */
        async function removerPasso(i) {
            timelineVenda.splice(i, 1);
            await salvarNoBanco();
        }

        /**
         * SINCRONIZAÇÃO DA TIMELINE COM A API
         * Persiste alterações no banco de dados
         * @async
         */
        async function salvarNoBanco() {
            await fetch(`/api/products/update-timeline/${skuAtual}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(timelineVenda)
            });
            renderizarEditor();
        }

        /**
         * ATUALIZAÇÃO DA PONTUAÇÃO DE PERFORMANCE
         * Atualiza contador e barra de progresso
         * @param {number} pts - Pontos a serem adicionados (pode ser negativo)
         */
        function atualizarPontuacao(pts) {
            pontuacao += pts;
            document.getElementById('pontosVenda').innerText = `${pontuacao} pts`;
            document.getElementById('barraPerformance').style.width = `${Math.min(pontuacao / 10, 100)}%`;
        }

        /**
         * RESET DO ESTADO DE ATENDIMENTO
         * Reinicia todas as variáveis e UI para novo atendimento
         */
        function resetarEstadoAtendimento() {
            // 1. Zerar Variáveis Lógicas
            pontuacao = 0;
            carrinhoAtual = [];
            tempoSegundos = 0;

            // 2. Parar Timers
            if (coachInterval) clearInterval(coachInterval);

            // 3. Atualizar UI (Pontos e Barra)
            document.getElementById('pontosVenda').innerText = `0 pts`;
            document.getElementById('barraPerformance').style.width = `0%`;

            // 4. Atualizar UI (Carrinho e Badge)
            renderizarCarrinho();

            // 5. Esconder Painéis Específicos
            document.getElementById('panelCoach').classList.add('hidden');
            document.getElementById('btnCancelar').classList.add('hidden');

            if (document.getElementById('timerCoach')) {
                document.getElementById('timerCoach').innerText = "00:00";
            }
        }

        /**
         * CONFIRMAÇÃO DE DESISTÊNCIA
         * Processa o motivo da desistência e reseta o sistema
         * @param {string} motivo - Motivo da desistência selecionado
         * @async
         */
        async function confirmarDesistencia(motivo) {
            fecharModalDesistencia();

            // Aplica o reset completo do atendimento
            resetarEstadoAtendimento();
            limparPainelCentral();

            // Log do motivo (em produção enviaria para API)
            console.log(`Atendimento encerrado por desistência. Motivo: ${motivo}`);
            mostrarAvisoVisual("Atendimento cancelado");
        }

        /**
         * VENDA DIRETA DE ITEM
         * Vende uma unidade do produto atual (não usa carrinho)
         * @async
         * @deprecated Preferir uso do carrinho
         */
        async function venderItem() {
            const res = await fetch(`/api/products/sell/${skuAtual}`, { method: 'PATCH' });
            if (res.ok) {
                const data = await res.json();
                const novaQtd = data.novoEstoque;
                document.getElementById('resQtd').innerText = novaQtd;
                const badgeEstoque = document.querySelector(`#btn-sku-${skuAtual} span:last-child`);
                if (badgeEstoque) badgeEstoque.innerText = `Estoque: ${novaQtd}`;
                atualizarBotaoHeader(novaQtd);
                await carregarCatalogo();
                atualizarPontuacao(100);
                document.getElementById('panelCoach').classList.add('hidden');
                if (coachInterval) clearInterval(coachInterval);
                alert("Venda realizada!");
            }
        }

        /**
         * FILTRAGEM DA LISTA DE PRODUTOS
         * Filtra produtos em tempo real baseado no input de busca
         */
        function filtrarLista() {
            const input = document.getElementById('filtroLista');
            if (!input) return;

            const t = input.value.toLowerCase();
            const btnLimpar = document.getElementById('btnLimparFiltro');

            // Controla visibilidade do botão "X"
            if (btnLimpar) {
                btnLimpar.classList.toggle('hidden', t === "");
            }

            // Filtra cards da lista
            const cards = document.querySelectorAll('.card-modelo');
            cards.forEach(c => {
                const textoCard = c.innerText.toLowerCase();
                c.style.display = textoCard.includes(t) ? 'flex' : 'none';
            });
        }

        /**
         * LIMPEZA DO FILTRO DE BUSCA
         * Restaura visibilidade de todos os itens
         */
        function limparFiltro() {
            const input = document.getElementById('filtroLista');
            if (input) {
                input.value = "";
                filtrarLista();
                input.focus();
            }
        }

        /**
         * ATUALIZAÇÃO DO BOTÃO DO HEADER
         * Controla estado do botão baseado no estoque
         * @param {number} qtd - Quantidade disponível em estoque
         */
        function atualizarBotaoHeader(qtd) {
            const btn = document.getElementById('btnHeaderVender');
            btn.disabled = qtd <= 0;
            btn.className = qtd > 0
                ? "px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-[11px] uppercase shadow-lg shadow-blue-200"
                : "px-6 py-2.5 bg-slate-100 text-slate-400 rounded-xl font-bold text-[11px] uppercase cursor-not-allowed border";
        }

        /**
         * CONTROLE DE VISIBILIDADE DO CARRINHO
         * Alterna entre aberto/fechado com animação slide
         */
        function toggleCarrinho() {
            document.getElementById('carrinhoLateral').classList.toggle('open');
        }

        /**
         * ADIÇÃO DE ITEM AO CARRINHO
         * Adiciona o produto atual ao carrinho com pontuação
         */
        function adicionarAoCarrinho() {
            const nome = document.getElementById('resNome').innerText;
            const precoStr = document.getElementById('resPreco').innerText.replace('R$ ', '').replace(',', '.');
            const preco = parseFloat(precoStr);
            const sku = skuAtual;

            if (!sku) return alert("Selecione um tamanho primeiro!");

            // Definição da pontuação (100 pontos por item normal)
            const pontosParaEsteItem = 100;

            const itemExistente = carrinhoAtual.find(i => i.sku === sku);

            if (itemExistente) {
                itemExistente.qtd++;
            } else {
                carrinhoAtual.push({
                    sku,
                    nome,
                    preco,
                    qtd: 1,
                    pontosPorUnidade: pontosParaEsteItem
                });
            }

            // Atualiza pontuação
            atualizarPontuacao(pontosParaEsteItem);

            // Renderiza carrinho
            renderizarCarrinho();

            // Feedback visual
            mostrarAvisoVisual(nome);

            // Animação no badge
            const badge = document.getElementById('badgeCarrinho');
            badge.classList.remove('animate-bounce');
            void badge.offsetWidth;
            badge.classList.add('animate-bounce');
        }

        /**
         * ADIÇÃO DE MAIS UMA UNIDADE NO CARRINHO
         * Incrementa quantidade de item existente
         * @param {number} index - Índice do item no array carrinhoAtual
         */
        function adicionarMaisUm(index) {
            const item = carrinhoAtual[index];

            // Incrementa quantidade
            item.qtd++;

            // Soma pontuação proporcional
            const pontosASomar = item.pontosPorUnidade || 100;
            atualizarPontuacao(pontosASomar);

            // Atualiza interface
            renderizarCarrinho();

            // Animação no badge
            const badge = document.getElementById('badgeCarrinho');
            badge.classList.remove('animate-bounce');
            void badge.offsetWidth;
            badge.classList.add('animate-bounce');
        }

        /**
         * RENDERIZAÇÃO DO CARRINHO
         * Atualiza interface do carrinho lateral e totais
         */
        function renderizarCarrinho() {
            const lista = document.getElementById('listaItensCarrinho');
            const badge = document.getElementById('badgeCarrinho');
            let total = 0;

            lista.innerHTML = carrinhoAtual.map((item, index) => {
                total += (item.preco * item.qtd);

                return `
            <div class="flex flex-col p-4 bg-slate-50 rounded-2xl border border-slate-100 relative group animate-in fade-in duration-300">
                <div class="flex justify-between items-start">
                    <span class="text-[9px] font-black text-blue-600 uppercase">${item.sku}</span>
                    <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded-full">x${item.qtd}</span>
                </div>
                <span class="text-xs font-bold text-slate-700 mt-1">${item.nome}</span>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-sm font-black text-slate-900">R$ ${(item.preco * item.qtd).toFixed(2).replace('.', ',')}</span>
                    
                    <div class="flex items-center gap-1 bg-white p-1 rounded-xl border shadow-sm">
                        <button onclick="removerDoCarrinho(${index})" class="p-1.5 text-red-400 hover:bg-red-50 rounded-lg transition-all">
                            <i data-lucide="minus-circle" class="w-4 h-4"></i>
                        </button>
                        
                        <button onclick="adicionarMaisUm(${index})" class="p-1.5 text-emerald-500 hover:bg-emerald-50 rounded-lg transition-all">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>`;
            }).join('');

            // Atualiza totais
            document.getElementById('totalCarrinho').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;

            // Atualiza badge do header
            const totalItens = carrinhoAtual.reduce((acc, curr) => acc + curr.qtd, 0);
            badge.innerText = totalItens;
            badge.classList.toggle('hidden', totalItens === 0);

            lucide.createIcons();
        }

        /**
         * FINALIZAÇÃO DO PEDIDO
         * Sincroniza vendas com a API e reseta o sistema
         * @async
         */
        async function finalizarPedido() {
            if (carrinhoAtual.length === 0) return alert("O carrinho está vazio!");

            try {
                // Cria requisições para cada SKU com quantidade específica
                const promessasVenda = carrinhoAtual.map(item =>
                    fetch(`/api/products/sell/${item.sku}?quantity=${item.qtd}`, { method: 'PATCH' })
                );

                // Aguarda todas as requisições
                const resultados = await Promise.all(promessasVenda);

                if (resultados.every(r => r.ok)) {
                    // Atualização da UI
                    await carregarCatalogo();
                    if (skuAtual) {
                        await atualizarDadosProdutoAberto(skuAtual);
                    }

                    // Reset do atendimento
                    resetarEstadoAtendimento();
                    limparPainelCentral();

                    // Feedback e limpeza
                    mostrarAvisoVisual("Venda sincronizada com sucesso!");
                    carrinhoAtual = [];
                    renderizarCarrinho();

                    // Fecha carrinho se aberto
                    if (document.getElementById('carrinhoLateral').classList.contains('open')) {
                        toggleCarrinho();
                    }

                    // Reset do coach
                    clearInterval(coachInterval);
                    tempoSegundos = 0;
                    if (document.getElementById('timerCoach')) {
                        document.getElementById('timerCoach').innerText = "00:00";
                    }
                    document.getElementById('panelCoach').classList.add('hidden');
                } else {
                    const erroMsg = await resultados.find(r => !r.ok).text();
                    alert("Erro na sincronização: " + erroMsg);
                }
            } catch (err) {
                console.error("Erro na sincronização:", err);
            }
        }

        /**
         * ATUALIZAÇÃO DOS DADOS DO PRODUTO ABERTO
         * Atualiza estoque na UI após vendas
         * @param {string} sku - SKU do produto a ser atualizado
         * @async
         */
        async function atualizarDadosProdutoAberto(sku) {
            try {
                const res = await fetch(`/api/products/sku/${sku}`);
                if (!res.ok) return;
                const data = await res.json();

                // Atualiza contador de estoque principal
                const resQtd = document.getElementById('resQtd');
                if (resQtd) resQtd.innerText = data.details.quantity;

                // Atualiza estoque na grade de tamanhos
                const btnVariante = document.querySelector(`#btn-sku-${sku} span:last-child`);
                if (btnVariante) {
                    btnVariante.innerText = `Estoque: ${data.details.quantity}`;
                }

                // Atualiza estado do botão do header
                atualizarBotaoHeader(data.details.quantity);

            } catch (error) {
                console.error("Erro ao atualizar dados do produto aberto:", error);
            }
        }

        /**
         * REMOÇÃO DE ITEM DO CARRINHO
         * Remove ou decrementa quantidade com ajuste de pontuação
         * @param {number} index - Índice do item no array carrinhoAtual
         */
        function removerDoCarrinho(index) {
            const item = carrinhoAtual[index];

            // Recupera valor de pontuação do item
            const pontosADeduzir = item.pontosPorUnidade || 100;

            // Lógica de remoção/decremento
            if (item.qtd > 1) {
                item.qtd--;
            } else {
                carrinhoAtual.splice(index, 1);
            }

            // Ajuste de pontuação (negativo)
            atualizarPontuacao(-pontosADeduzir);

            // Atualiza interface
            renderizarCarrinho();

            console.log(`Dedução de performance: -${pontosADeduzir} pts por remoção de ${item.nome}`);
        }

        /**
         * ENVIO DE TELEMETRIA
         * Simula envio de dados de performance (em produção enviaria para API)
         * @param {Array} itens - Itens vendidos no atendimento
         */
        function enviarTelemetria(itens) {
            console.log("Enviando telemetria do vendedor:", vendedorId, "Duração:", tempoSegundos, "Itens:", itens);
        }

        /**
         * ADIÇÃO DE CROSS-SELL AO CARRINHO
         * Adiciona produto sugerido com pontuação diferenciada
         * @param {string} sku - SKU do produto de cross-sell
         * @param {string} nome - Nome do produto
         * @param {number} preco - Preço do produto
         */
        function adicionarCrossSellAoCarrinho(sku, nome, preco) {
            // Pontuação diferenciada para cross-sell (150 pontos)
            const pontosParaEsteItem = 150;

            // Lógica de adição ao carrinho
            const itemExistente = carrinhoAtual.find(i => i.sku === sku);

            if (itemExistente) {
                itemExistente.qtd++;
            } else {
                carrinhoAtual.push({
                    sku,
                    nome,
                    preco,
                    qtd: 1,
                    pontosPorUnidade: pontosParaEsteItem
                });
            }

            // Pontuação e UI
            atualizarPontuacao(pontosParaEsteItem);
            renderizarCarrinho();

            // Feedback visual
            mostrarAvisoVisual(nome);

            // Animação no badge
            const badge = document.getElementById('badgeCarrinho');
            badge.classList.remove('animate-bounce');
            void badge.offsetWidth;
            badge.classList.add('animate-bounce');
        }

        /**
         * EXIBIÇÃO DE NOTIFICAÇÃO TOAST
         * Feedback visual temporário para ações do usuário
         * @param {string} nome - Nome do produto/acao para exibição
         */
        function mostrarAvisoVisual(nome) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            toast.className = "toast-success bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 font-bold text-xs uppercase tracking-widest";
            toast.innerHTML = `
        <i data-lucide="check-circle" class="w-4 h-4"></i>
        <span>${nome} adicionado!</span>
    `;

            container.appendChild(toast);
            lucide.createIcons();

            // Auto-remove após 3 segundos
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        /**
         * LIMPEZA DO PAINEL CENTRAL
         * Reseta a UI para estado inicial (sem produto selecionado)
         */
        function limparPainelCentral() {
            // 1. Reseta o SKU de controle
            skuAtual = "";

            // 2. Esconde o container de detalhes e seções auxiliares
            document.getElementById('detalhesProduto').classList.add('hidden');
            document.getElementById('secaoSugestoes').classList.add('hidden');
            document.getElementById('btnCancelar').classList.add('hidden');
            document.getElementById('containerDiferenciais').classList.add('hidden');

            // 3. Remove o destaque (active-item) de qualquer card na lista lateral
            document.querySelectorAll('.card-modelo').forEach(c => c.classList.remove('active-item'));

            // 4. Limpa o timer e esconde o Coach
            if (coachInterval) clearInterval(coachInterval);
            document.getElementById('panelCoach').classList.add('hidden');
        }

        async function abrirQuickView(sku) {
            const modal = document.getElementById('modalQuickView');
            if (!modal) return;

            try {
                // 1. Busca os detalhes do produto clicado
                const res = await fetch(`/api/products/sku/${sku}`);
                if (!res.ok) return;
                const data = await res.json();
                const base = data.details || data;

                // 2. Busca TODOS os produtos para montar a grade de tamanhos (mesmo nome)
                const resTodos = await fetch('/api/products');
                const todos = await resTodos.json();

                // Filtra produtos que tenham o mesmo nome (ignorando maiúsculas/minúsculas)
                const nomeParaBusca = (data.name || base.name).toLowerCase();
                const variacoes = todos.filter(p => (p.name || p.Name).toLowerCase() === nomeParaBusca);

                // 3. Preenchimento do Cabeçalho
                document.getElementById('qvNome').innerText = data.name || base.name;
                document.getElementById('qvCategoria').innerText = data.category || base.category;
                document.getElementById('qvPreco').innerText = `R$ ${(data.price || base.price).toFixed(2).replace('.', ',')}`;
                document.getElementById('qvLocal').innerText = `${data.aisle || base.aisle} / ${data.shelf || base.shelf}`;

                // 4. Renderização da Grade de Tamanhos (Horizontal e Compacta)
                const containerGrade = document.getElementById('qvGradeTamanhos');
                containerGrade.innerHTML = `
            <p class="text-[9px] font-bold text-slate-400 uppercase mb-2 tracking-widest">Grade Disponível</p>
            <div class="flex flex-wrap gap-2">
                ${variacoes.map(v => {
                    const vSpecs = v.specifications || v.Specifications || {};
                    const tam = vSpecs.Tamanho || vSpecs.tamanho || "U";
                    const est = v.quantity ?? v.Quantity ?? 0;
                    const isAtual = v.sku === sku || v.SKU === sku;

                    return `
                        <div class="flex flex-col items-center min-w-[50px] p-2 rounded-lg border ${isAtual ? 'border-blue-600 bg-blue-50' : 'border-slate-100 bg-white'}">
                            <span class="text-[10px] font-bold ${isAtual ? 'text-blue-700' : 'text-slate-500'}">${tam}</span>
                            <span class="text-[8px] font-medium ${est > 0 ? 'text-emerald-600' : 'text-red-400'}">${est} un.</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

                // 5. Diferencial
                const dicaVenda = data.salesTip || base.salesTip || base.benefits;
                const containerDif = document.getElementById('qvContainerDif');
                if (dicaVenda) {
                    containerDif.classList.remove('hidden');
                    document.getElementById('qvTextoDif').innerText = dicaVenda;
                } else {
                    containerDif.classList.add('hidden');
                }

                // 6. Especificações (Apenas as que não são "Tamanho")
                const listaSpecs = document.getElementById('qvListaSpecs');
                const specsObj = data.specifications || base.specifications || {};
                const entries = Object.entries(specsObj).filter(([key]) => key.toLowerCase() !== 'tamanho');

                listaSpecs.innerHTML = entries.map(([key, value]) => `
            <div class="flex justify-between border-b border-slate-50 py-1.5">
                <span class="text-[9px] font-bold text-slate-400 uppercase">${key}</span>
                <span class="text-[10px] font-bold text-slate-700">${value}</span>
            </div>
        `).join('');

                modal.classList.remove('hidden');
                lucide.createIcons();
            } catch (err) {
                console.error("Erro ao carregar grade no modal:", err);
            }
        }

        function fecharQuickView() {
            document.getElementById('modalQuickView').classList.add('hidden');
        }
    </script>
</body>

</html>